version: '3.8'

services:
  # ============================================================
  # OMNI2 Bridge Application
  # ============================================================
  omni2:
    build:
      context: .
      target: development
    container_name: omni2-bridge
    # ports:
    #   - "8000:8000"  # REMOVED: No direct access - only via Traefik
    volumes:
      # Mount code for hot-reload
      - .:/app
      # Mount logs
      - ./logs:/app/logs
      # Mount Docker socket for stdio MCP servers (like GitHub MCP)
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # Application
      - APP_ENV=development
      - APP_DEBUG=true
      - APP_HOST=0.0.0.0
      - APP_PORT=8000
      - APP_RELOAD=true
      
      # Database (use omni_pg_db container)
      - DATABASE_HOST=omni_pg_db
      - DATABASE_PORT=5432
      - DATABASE_NAME=omni
      - DATABASE_USER=omni
      - DATABASE_PASSWORD=omni
      - DATABASE_SCHEMA=omni2
      - DATABASE_POOL_SIZE=20
      - DATABASE_MAX_OVERFLOW=10
      
      # Anthropic API
      # Available models (as of Dec 2025):
      # Claude 4.5: claude-sonnet-4-5-20250929, claude-opus-4-5-20251101, claude-haiku-4-5-20251001
      # Claude 4.0: claude-sonnet-4-20250514, claude-opus-4-20250514
      # Claude 3.7: claude-3-7-sonnet-20250219
      # Claude 3.5: claude-3-5-haiku-20241022 (fast & cost-effective)
      # Claude 3.0: claude-3-opus-20240229, claude-3-haiku-20240307
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-sonnet-4-5-20250929}
      - ANTHROPIC_MAX_TOKENS=${ANTHROPIC_MAX_TOKENS:-4096}
      - ANTHROPIC_TIMEOUT=${ANTHROPIC_TIMEOUT:-30}
      
      # Security
      - SECRET_KEY=${SECRET_KEY:-change-this-in-production}
      - CORS_ENABLED=true
      
      # Logging
      - LOG_LEVEL=INFO
      - LOG_FORMAT=json
      
      # MCP Servers (connect to other containers or host)
      - MCP_ORACLE_ENABLED=true
      - MCP_ORACLE_URL=http://host.docker.internal:8001
      - MCP_ORACLE_TIMEOUT=30
      - MCP_ORACLE_API_KEY=${MCP_ORACLE_API_KEY:-U1f1mzzSvNKhrtntjJeE0O1KUz-7r7TiuR1-ushQXoc}
      
      # Informatica MCP
      - INFORMATICA_MCP_TOKEN=${INFORMATICA_MCP_TOKEN}
      
      # GitHub MCP (stdio via Docker)
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN}
      
      # Slack Bot (optional for Phase 1)
      - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN:-}
      - SLACK_APP_TOKEN=${SLACK_APP_TOKEN:-}
      - SLACK_SIGNING_SECRET=${SLACK_SIGNING_SECRET:-}

      # Redis
      - REDIS_ENABLED=${REDIS_ENABLED:-false}
      - REDIS_HOST=${REDIS_HOST:-omni2-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-}
      - REDIS_DB=${REDIS_DB:-0}
      - REDIS_SSL=${REDIS_SSL:-false}
    
    networks:
      - omni2-network
      - mcp-gateway-net
      - db-net
      - redis-net
    
    
    restart: unless-stopped
    
    # Traefik labels for external gateway
    labels:
      - "traefik.enable=true"
      
      # Public endpoints (no auth)
      - "traefik.http.routers.omni2-public.rule=PathPrefix(`/health`) || PathPrefix(`/docs`) || PathPrefix(`/openapi.json`)"
      - "traefik.http.routers.omni2-public.entrypoints=web"
      - "traefik.http.routers.omni2-public.service=omni2"
      - "traefik.http.routers.omni2-public.priority=50"
      
      # WebSocket endpoint (WITH ForwardAuth)
      - "traefik.http.routers.omni2-ws.rule=Path(`/ws`)"
      - "traefik.http.routers.omni2-ws.entrypoints=web"
      - "traefik.http.routers.omni2-ws.middlewares=auth-forward"
      - "traefik.http.routers.omni2-ws.service=omni2"
      - "traefik.http.routers.omni2-ws.priority=200"
      
      # WebSocket Chat endpoint (WITH ForwardAuth)
      - "traefik.http.routers.omni2-ws-chat.rule=Path(`/ws/chat`)"
      - "traefik.http.routers.omni2-ws-chat.entrypoints=web"
      - "traefik.http.routers.omni2-ws-chat.middlewares=auth-forward"
      - "traefik.http.routers.omni2-ws-chat.service=omni2"
      - "traefik.http.routers.omni2-ws-chat.priority=210"
      
      # Protected endpoints (with ForwardAuth) - use /api/v1 to avoid conflict
      - "traefik.http.routers.omni2-protected.rule=PathPrefix(`/api/v1`)"
      - "traefik.http.routers.omni2-protected.entrypoints=web"
      - "traefik.http.routers.omni2-protected.middlewares=auth-forward,cors"
      - "traefik.http.routers.omni2-protected.service=omni2"
      - "traefik.http.routers.omni2-protected.priority=100"
      
      # MCP Direct endpoint (NO ForwardAuth - validates opaque tokens internally)
      - "traefik.http.routers.omni2-mcp.rule=PathPrefix(`/mcp`)"
      - "traefik.http.routers.omni2-mcp.entrypoints=web"
      - "traefik.http.routers.omni2-mcp.service=omni2"
      - "traefik.http.routers.omni2-mcp.priority=150"
      
      # Service definition
      - "traefik.http.services.omni2.loadbalancer.server.port=8000"
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================
  # OMNI2 Analytics MCP - Internal Analytics (Admin Only)
  # ============================================================
  # analytics_mcp:
  #   build:
  #     context: ./Analytics_MCP/server
  #     dockerfile: Dockerfile
  #   container_name: omni2-analytics-mcp
  #   ports:
  #     - "8302:8302"
  #   volumes:
  #     # Mount code for hot-reload
  #     - ./Analytics_MCP/server:/app
  #   environment:
  #     - DATABASE_URL=postgresql://omni:omni@host.docker.internal:5435/omni
  #     - MCP_SERVER_NAME=omni2_analytics_mcp
  #     - MCP_PORT=8302
  #     - MCP_SERVER_URL=http://analytics_mcp:8302/mcp/
  #     - CORS_ORIGINS=http://localhost,http://127.0.0.1,http://omni2
  #     - LOG_LEVEL=INFO
  #     - AUTO_DISCOVER=true
  #   networks:
  #     - omni2-network
  #
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8302/healthz"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 20s

  # ============================================================
  # PostgreSQL Database - REMOVED (using external pg_omni2)
  # ============================================================
  # Now using external database at host.docker.internal:5435
  # Container: omni_pg_db
  # Database: omni
  # User: omni
  # Password: omni

  # ============================================================
  # Slack Bot (Phase 6 - Natural language Slack integration)
  # ============================================================
  # slack_bot:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.slack
  #   container_name: omni2-slack-bot
  #   environment:
  #     - SLACK_BOT_TOKEN=${SLACK_BOT_TOKEN}
  #     - SLACK_APP_TOKEN=${SLACK_APP_TOKEN}
  #     - OMNI2_URL=http://omni2:8000
  #     - DEFAULT_USER_EMAIL=${DEFAULT_USER_EMAIL:-default@company.com}
  #   volumes:
  #     - ./config:/app/config:ro  # Mount config directory for slack.yaml
  #     - ./slack_bot_omni.py:/app/slack_bot_omni.py  # Hot-reload for development
  #     - ../QA_MCP/data/snapshots:/app/data/snapshots  # QA_MCP snapshots folder (shared with qa_mcp)
  #   networks:
  #     - omni2-network
  #   depends_on:
  #     - omni2
  #   restart: unless-stopped
  #   # Note: Slack bot uses Socket Mode (WebSocket), no ports needed

  # ============================================================
  # QA MCP Server - NOW RUNS SEPARATELY via Traefik Gateway
  # ============================================================
  # qa_mcp is now behind Traefik at http://mcp-gateway-traefik/qa-mcp/
  # Start it with: cd ../QA_MCP && docker-compose up -d
  # qa_mcp:
  #   image: qa_mcp-qa_mcp:latest  # Use the image built from QA_MCP folder
  #   container_name: omni2-qa-mcp
  #   ports:
  #     - "9010:9010"
  #   environment:
  #     - MCP_PORT=9010
  #     - MCP_SERVER_NAME=QA_MCP_Server
  #     - AUTO_DISCOVER=true
  #   volumes:
  #     - ../QA_MCP/data/snapshots:/app/data/snapshots  # QA_MCP snapshots folder
  #   networks:
  #     - omni2-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD-SHELL", "curl -f http://localhost:9010/healthz || exit 1"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

  # ============================================================
  # Informatica MCP Server - NOW RUNS SEPARATELY via Traefik Gateway
  # ============================================================
  # informatica_mcp is now behind Traefik at http://mcp-gateway-traefik/informatica-mcp/
  # Has sticky sessions for stateful investigation feature
  # Start it with: cd ../informatica_mcp && docker-compose up -d
  # informatica_mcp:
  #   image: informatica_mcp:latest  # Use the image built from informatica_mcp folder
  #   container_name: omni2-informatica-mcp
  #   ports:
  #     - "9013:9013"
  #   environment:
  #     # PCI Database
  #     - PCI_HOST=${INFORMATICA_PCI_HOST:-infodb-01.dev.bos.credorax.com}
  #     - PCI_PORT=${INFORMATICA_PCI_PORT:-1521}
  #     - PCI_SERVICE=${INFORMATICA_PCI_SERVICE:-INFODEV}
  #     - PCI_USER=${INFORMATICA_PCI_USER:-infra_rep_ds_dev01}
  #     - PCI_PASSWORD=${INFORMATICA_PCI_PASSWORD:-infra_rep_ds_dev0199}
  #     # NPCI Database
  #     - NPCI_HOST=${INFORMATICA_NPCI_HOST:-infodb-01.dev.bos.credorax.com}
  #     - NPCI_PORT=${INFORMATICA_NPCI_PORT:-1521}
  #     - NPCI_SERVICE=${INFORMATICA_NPCI_SERVICE:-INFODEV}
  #     - NPCI_USER=${INFORMATICA_NPCI_USER:-infra_rep_ds_dev01}
  #     - NPCI_PASSWORD=${INFORMATICA_NPCI_PASSWORD:-infra_rep_ds_dev0199}
  #     # Authentication (optional)
  #     - INFORMATICA_MCP_TOKEN=${INFORMATICA_MCP_TOKEN:-}
  #     # Folder filtering (optional)
  #     - FOLDER_FILTER=${INFORMATICA_FOLDER_FILTER:-Billing,Data_Services,Credorate,Transformer,Transformer_ODS,Interfaces,PCI_TRANSFORMER,PCI}
  #   networks:
  #     - omni2-network
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD-SHELL", "curl -f http://localhost:9013/health || exit 1"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 40s

  # ============================================================
  # Redis (Phase 7 - for caching and sessions)
  # ============================================================
  redis:
    image: redis:latest
    container_name: omni2-redis
    volumes:
      - redis-data:/data
    networks:
      - redis-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

# ============================================================
# Networks
# ============================================================
networks:
  omni2-network:
    driver: bridge
  # Connect to MCP Gateway for load-balanced MCPs
  mcp-gateway-net:
    external: true
  # Connect to PostgreSQL database
  db-net:
    external: true
  # Private Redis network (only omni2 + redis)
  redis-net:
    internal: true

# ============================================================
# Volumes
# ============================================================
volumes:
  redis-data:
    driver: local
  # postgres-data - REMOVED (using external pg_omni2)
  # qa_snapshots - now using local folder mount instead of volume
  # redis-data - not used yet

# ============================================================
# Usage Instructions
# ============================================================
# 1. Build and start all services:
#    docker-compose up --build
#
# 2. Start in background:
#    docker-compose up -d
#
# 3. View logs:
#    docker-compose logs -f omni2
#
# 4. Stop all services:
#    docker-compose down
#
# 5. Stop and remove volumes:
#    docker-compose down -v
#
# 6. Use existing host PostgreSQL instead of container:
#    - Comment out the postgres service
#    - Change DATABASE_HOST to host.docker.internal
#    - Change DATABASE_PORT to your host PostgreSQL port (usually 5432)
#
# 7. Access OMNI2:
#    - API: http://localhost:8000
#    - Docs: http://localhost:8000/docs
#    - Health: http://localhost:8000/health
#
# 8. Connect to PostgreSQL container:
#    docker exec -it omni2-postgres psql -U postgres -d omni
# ============================================================
